// ==UserScript==
// @name         Yalla-Visa v20.6 ‚Äî Fixed Timer + Smooth Glass UI + Latency Monitor
// @namespace    http://tampermonkey.net/
// @version      20.6
// @description  Fixed timer accuracy + smooth UI + latency tracking + persistent settings.
// @match        *://*.almaviva-visa.it/*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function () {
  'use strict';

  let token = '';
  let isRunning = false;
  let schedule = [];
  let retryDelay = 500;
  let nextTimer = null;
  let nextTargetTime = null;
  let attemptCount = 0;
  let latencyList = [];

  let clockDisplay, countdownLabel, attemptCounterLabel, latencyLabel, logArea;
  let visaSelect, retryDelayInput, tokenRefreshInput, timeContainer;
  let startBtn, stopBtn, sendNowBtn, skipBtn;

const apiUrls = {
    'ŸÑŸÖ ÿ¥ŸÖŸÑ ÿßŸÑŸàÿßŸÑÿØŸäŸÜ (D) - ÿßŸÑŸÇÿßŸáÿ±ÿ©': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=1&visaId=19&serviceLevelId=1',
    'ŸÑŸÖ ÿ¥ŸÖŸÑ ÿßŸÑŸàÿßŸÑÿØŸäŸÜ (D) - ÿßŸÑÿßÿ≥ŸÉŸÜÿØÿ±ŸäŸá': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=1&visaId=19&serviceLevelId=1',
    'ŸÑŸÖ ÿ¥ŸÖŸÑ ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨ (D) - ÿßŸÑŸÇÿßŸáÿ±ÿ©': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=1&visaId=18&serviceLevelId=1',
    'ŸÑŸÖ ÿ¥ŸÖŸÑ ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨ (D) - ÿßŸÑÿßÿ≥ŸÉŸÜÿØÿ±ŸäŸá': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=2&visaId=18&serviceLevelId=1',
    'ŸÑŸÖ ÿ¥ŸÖŸÑ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ (D) - ÿßŸÑŸÇÿßŸáÿ±ÿ©': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=1&visaId=20&serviceLevelId=1',
    'ŸÑŸÖ ÿ¥ŸÖŸÑ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ (D) - ÿßŸÑÿßÿ≥ŸÉŸÜÿØÿ±ŸäŸá': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=2&visaId=20&serviceLevelId=1',
    'ÿ±ÿ¨ÿßŸÑ ÿßŸÑÿ£ÿπŸÖÿßŸÑ (C) - ÿßŸÑŸÇÿßŸáÿ±ÿ©': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=1&visaId=5&serviceLevelId=1',
    'ÿ≥Ÿäÿßÿ≠ÿ© (C) - ÿßŸÑŸÇÿßŸáÿ±ÿ©': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=1&visaId=1&serviceLevelId=1',
    'ÿ≥Ÿäÿßÿ≠ÿ© (C) - ÿßŸÑÿßÿ≥ŸÉŸÜÿØÿ±ŸäŸá': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=2&visaId=1&serviceLevelId=1',
    'Re-Entry (C) - Cairo': 'https://egyapi.almaviva-visa.it/reservation-manager/api/planning/v1/checks?officeId=1&visaId=4&serviceLevelId=1'
  };


  const beep = (f) => {
    try {
      const ctx = new AudioContext();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'square';
      o.connect(g);
      g.connect(ctx.destination);
      o.frequency.value = f;
      g.gain.setValueAtTime(0.05, ctx.currentTime);
      o.start();
      o.stop(ctx.currentTime + 0.1);
    } catch {}
  };

  const playAlarm = () => {
    try {
      const ctx = new AudioContext();
      const g = ctx.createGain();
      g.connect(ctx.destination);
      [800, 1000, 1200].forEach((f, i) => {
        const o = ctx.createOscillator();
        o.type = 'sine';
        o.frequency.value = f;
        o.connect(g);
        o.start(ctx.currentTime + i * 0.25);
        o.stop(ctx.currentTime + (i + 1) * 0.25);
      });
    } catch {}
  };

  const log = (msg) => {
    const t = new Date();
    const ts = `${t.toLocaleTimeString('en-GB', { hour12: false })}:${String(t.getMilliseconds()).padStart(3, '0')}`;
    const line = `[${ts}] ${msg}`;
    if (logArea) {
      logArea.value += line + '\n';
      logArea.scrollTop = logArea.scrollHeight;
    }
    console.log(line);
  };

  const retrieveToken = () => {
    token =
      sessionStorage.getItem('access_token') ||
      document.cookie.split(';').find((c) => c.trim().startsWith('access_token='))?.split('=')[1] ||
      '';
    log(`üîë Token ${token ? 'retrieved' : 'missing'}`);
  };

  const saveSettings = () => {
    const times = Array.from(timeContainer.querySelectorAll('.time-row')).map((r) => {
      const [t, rty] = r.querySelectorAll('input');
      return { time: t.value, retry: rty.value };
    });
    const data = {
      visa: visaSelect.value,
      retryDelay: retryDelayInput.value,
      tokenRefresh: tokenRefreshInput.value,
      times,
    };
    localStorage.setItem('visaScheduler', JSON.stringify(data));
  };

  async function sendApiRequest(visaType, retriesLeft) {
    beep(600);
    attemptCount++;
    attemptCounterLabel.textContent = `Attempts: ${attemptCount}`;
    log(`üì° Attempt #${attemptCount} for ${visaType}`);

    const url = apiUrls[visaType];
    if (!url) return log(`‚ö†Ô∏è No API URL found for ${visaType}`);

    const startTime = performance.now();
    try {
      const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
      const txt = (await res.text()).trim();
      const latency = performance.now() - startTime;
      latencyList.push(latency);
      const avg = latencyList.reduce((a, b) => a + b, 0) / latencyList.length;
      latencyLabel.textContent = `‚ö° Avg Latency: ${avg.toFixed(2)} ms`;

      log(`üì• Response (${latency.toFixed(1)}ms): ${txt}`);

      if (txt === 'true') {
        log('‚úÖ Appointment FOUND!');
        playAlarm();
        skipBtn.disabled = false;
        skipBtn.style.background = '#ffc107';
        alert('‚úÖ Appointment found!');
        isRunning = false;
        clearTimeout(nextTimer);
      } else if (retriesLeft > 0) {
        setTimeout(() => sendApiRequest(visaType, retriesLeft - 1), retryDelay);
      } else {
        scheduleNext(visaType);
      }
    } catch (e) {
      log(`‚ö†Ô∏è Request error: ${e}`);
      scheduleNext(visaType);
    }
  }



  function findNextTiming(times) {
    const now = new Date();
    const currentMs = now.getMinutes() * 60000 + now.getSeconds() * 1000 + now.getMilliseconds();
    const sorted = times
      .map(([mm, ss, ms, r]) => ({
        mm,
        ss,
        ms,
        r,
        total: mm * 60000 + ss * 1000 + ms,
      }))
      .sort((a, b) => a.total - b.total);
    return sorted.find((t) => t.total > currentMs) || sorted[0];
  }
  function performPageSkip() {
    try {
      const skipEl = document.getElementsByClassName('visasys-button w-72')[2];
      if (skipEl) { skipEl.disabled = false; skipEl.click(); appendLog('‚è© Page SKIP clicked'); return true; }
      // try alternate selectors
      const btn = document.querySelector('button.skip, button[data-action="skip"], input[value="SKIP"]');
      if (btn) { btn.disabled=false; btn.click(); appendLog('‚è© Page SKIP (alternate) clicked'); return true; }
    } catch (e) { appendLog('‚ö† skip click failed: '+e); }
    appendLog('‚õî Skip button not found on page');
    return false;
  }


  function scheduleNext(visaType) {
    if (!isRunning) return;
    const next = findNextTiming(schedule);
    const now = new Date();

    // Compute time within the current HOUR (instead of minute)
    const nextTime = new Date(now);
    nextTime.setMinutes(next.mm);
    nextTime.setSeconds(next.ss);
    nextTime.setMilliseconds(next.ms);
    if (nextTime <= now) nextTime.setHours(nextTime.getHours() + 1);

    nextTargetTime = nextTime;
    const delay = nextTime - now;

    log(`‚è≥ Next request scheduled in ${(delay / 1000).toFixed(2)}s`);
    clearTimeout(nextTimer);
    nextTimer = setTimeout(() => sendApiRequest(visaType, next.r), delay);
  }

  function updateClock() {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    const ms = String(now.getMilliseconds()).padStart(3, '0');
    clockDisplay.textContent = `üïí ${hh}:${mm}:${ss}:${ms}`;
    if (nextTargetTime) {
      const diff = nextTargetTime - now;
      countdownLabel.textContent =
        diff > 0 ? `‚è≥ Next in ${(diff / 1000).toFixed(2)}s` : `‚ö° Executing...`;
    }
  }

  function createUI() {
    if (document.getElementById('yallaVisaPanel')) return;
    const saved = JSON.parse(localStorage.getItem('visaScheduler') || '{}');

    const panel = document.createElement('div');
    panel.id = 'yallaVisaPanel';
    panel.style.cssText = `
      position:fixed;top:80px;left:20px;width:380px;
      background:rgba(255,255,255,0.9);
      border-radius:12px;
      backdrop-filter:blur(10px);
      border:1px solid #007bff;
      box-shadow:0 6px 16px rgba(0,0,0,0.25);
      font-family:'Segoe UI',sans-serif;
      z-index:999999;
      transition:all 0.3s ease;
    `;

    // Header
    const header = document.createElement('div');
    header.style.cssText = `
      display:flex;justify-content:space-between;align-items:center;
      background:#007bff;color:white;padding:8px 12px;
      font-weight:bold;cursor:move;border-radius:12px 12px 0 0;
    `;
    const title = document.createElement('span');
    title.textContent = '‚úàÔ∏è Yalla-Visa Hunter v20.6';
    header.appendChild(title);

    const buttonsDiv = document.createElement('div');
    const minimizeBtn = document.createElement('button');
    minimizeBtn.textContent = '‚Äì';
    minimizeBtn.style.cssText =
      'background:#ffc107;border:none;border-radius:4px;width:24px;height:24px;margin-right:4px;cursor:pointer;';
    const resetBtn = document.createElement('button');
    resetBtn.textContent = 'üóë';
    resetBtn.style.cssText =
      'background:#dc3545;color:white;border:none;border-radius:4px;width:24px;height:24px;cursor:pointer;';
    buttonsDiv.append(minimizeBtn, resetBtn);
    header.appendChild(buttonsDiv);
    panel.appendChild(header);

    const content = document.createElement('div');
    content.style.cssText = 'padding:10px;';
    panel.appendChild(content);

    // Draggable
    let dragging = false,
      offsetX = 0,
      offsetY = 0;
    header.addEventListener('mousedown', (e) => {
      dragging = true;
      offsetX = e.clientX - panel.offsetLeft;
      offsetY = e.clientY - panel.offsetTop;
    });
    document.addEventListener('mouseup', () => (dragging = false));
    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      panel.style.left = e.clientX - offsetX + 'px';
      panel.style.top = e.clientY - offsetY + 'px';
    });

    minimizeBtn.onclick = () => {
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
      minimizeBtn.textContent = content.style.display === 'none' ? '+' : '‚Äì';
    };
    resetBtn.onclick = () => {
      if (confirm('Clear saved settings?')) {
        localStorage.removeItem('visaScheduler');
        location.reload();
      }
    };

    // Core
    clockDisplay = document.createElement('div');
    clockDisplay.style.cssText = 'font-size:18px;text-align:center;color:#007bff;font-weight:bold;';
    countdownLabel = document.createElement('div');
    countdownLabel.style.cssText = 'font-size:14px;text-align:center;color:#dc3545;margin-bottom:4px;';
    attemptCounterLabel = document.createElement('div');
    attemptCounterLabel.style.cssText = 'text-align:center;font-weight:bold;';
    latencyLabel = document.createElement('div');
    latencyLabel.style.cssText = 'text-align:center;color:#28a745;margin-bottom:6px;';
    latencyLabel.textContent = '‚ö° Avg Latency: -- ms';

    // Inputs
    visaSelect = document.createElement('select');
    visaSelect.style.cssText = 'width:100%;padding:6px;margin-bottom:6px;border-radius:6px;';
    Object.keys(apiUrls).forEach((k) => {
      const o = document.createElement('option');
      o.value = k;
      o.textContent = k;
      visaSelect.appendChild(o);
    });
    visaSelect.value = saved.visa || visaSelect.options[0].value;

    retryDelayInput = document.createElement('input');
    retryDelayInput.type = 'number';
    retryDelayInput.placeholder = 'Retry Delay (ms)';
    retryDelayInput.value = saved.retryDelay || retryDelay;
    retryDelayInput.style.cssText = 'width:100%;padding:6px;margin-bottom:6px;border-radius:6px;';

    tokenRefreshInput = document.createElement('input');
    tokenRefreshInput.type = 'number';
    tokenRefreshInput.placeholder = 'Reload Interval (min)';
    tokenRefreshInput.value = saved.tokenRefresh || 5;
    tokenRefreshInput.style.cssText = 'width:100%;padding:6px;margin-bottom:6px;border-radius:6px;';

    // Timers
    const timerHeader = document.createElement('div');
    timerHeader.innerHTML = '<b>‚è± Timers</b>';
    timerHeader.style.cssText =
      'cursor:pointer;margin:4px 0;padding:4px;background:#e9ecef;border-radius:6px;';
    timeContainer = document.createElement('div');
    timeContainer.style.display = 'block';
    timerHeader.onclick = () => {
      timeContainer.style.display = timeContainer.style.display === 'none' ? 'block' : 'none';
    };

    function addTimeRow(time = '', retry = 1) {
      const row = document.createElement('div');
      row.className = 'time-row';
      row.style.cssText = 'display:flex;align-items:center;margin-bottom:4px;';
      const t = document.createElement('input');
      t.placeholder = 'mm:ss:ms';
      t.value = time;
      t.style.cssText = 'flex:1;padding:4px;margin-right:4px;border-radius:4px;';
      const r = document.createElement('input');
      r.type = 'number';
      r.value = retry;
      r.style.cssText = 'width:50px;margin-right:4px;border-radius:4px;';
      const del = document.createElement('button');
      del.textContent = '‚úñ';
      del.style.cssText =
        'background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;padding:2px 5px;';
      del.onclick = () => {
        row.remove();
        saveSettings();
      };
      row.append(t, r, del);
      timeContainer.appendChild(row);
    }

    const defaultTimers = ['00:59:000', '04:59:000', '09:59:000', '14:59:000', '19:59:000'];
    if (saved.times?.length) saved.times.forEach((t) => addTimeRow(t.time, t.retry));
    else defaultTimers.forEach((t) => addTimeRow(t, 1));

    const addBtn = document.createElement('button');
    addBtn.textContent = '‚ûï Add Timing';
    addBtn.style.cssText =
      'width:100%;padding:6px;background:#17a2b8;color:white;border:none;border-radius:6px;margin-bottom:6px;';
    addBtn.onclick = () => {
      addTimeRow('', 1);
      saveSettings();
    };

    // Buttons
    startBtn = document.createElement('button');
    startBtn.textContent = '‚ñ∂Ô∏è Start Hunting';
    startBtn.style.cssText =
      'width:100%;padding:6px;background:#28a745;color:white;border:none;border-radius:6px;margin-bottom:6px;';
    stopBtn = document.createElement('button');
    stopBtn.textContent = '‚õî Stop';
    stopBtn.style.cssText =
      'width:100%;padding:6px;background:#dc3545;color:white;border:none;border-radius:6px;margin-bottom:6px;';
    sendNowBtn = document.createElement('button');
    sendNowBtn.textContent = '‚ö° Send Now';
    sendNowBtn.style.cssText =
      'width:100%;padding:6px;background:#007bff;color:white;border:none;border-radius:6px;margin-bottom:6px;';
    skipBtn = document.createElement('button');
    skipBtn.textContent = '‚è© SKIP';
    skipBtn.style.cssText =
      'width:100%;padding:6px;background:#6c757d;color:white;border:none;border-radius:6px;margin-bottom:6px;';
    skipBtn.disabled = true;

    startBtn.onclick = () => {
      if (isRunning) return alert('Already running!');
      const rows = Array.from(timeContainer.querySelectorAll('.time-row')).map((r) => {
        const [t, rty] = r.querySelectorAll('input');
        const [mm, ss, ms] = t.value.split(':').map(Number);
        return [mm, ss, ms, Number(rty.value) || 0];
      });
      if (!rows.length) return alert('Add valid timers.');
      schedule = rows;
      attemptCount = 0;
      latencyList = [];
      retryDelay = parseInt(retryDelayInput.value) || 500;
      isRunning = true;
      skipBtn.disabled = true;
      skipBtn.style.background = '#6c757d';
      log(`üéØ Started hunting ${visaSelect.value}`);
      scheduleNext(visaSelect.value);
    };

    stopBtn.onclick = () => {
      isRunning = false;
      clearTimeout(nextTimer);
      log('üõë Stopped.');
    };

    sendNowBtn.onclick = () => sendApiRequest(visaSelect.value, 0);

    skipBtn.onclick = () => {
      log('‚û°Ô∏è Manual Skip clicked');
      const el = document.querySelector('.visasys-button.w-72:nth-of-type(3)');
      if (el) el.click();
    };

    const logHeader = document.createElement('div');
    logHeader.textContent = 'ü™µ Logs';
    logHeader.style.cssText =
      'cursor:pointer;margin:4px 0;padding:4px;background:#e9ecef;border-radius:6px;';
     logArea = document.createElement('textarea');
    logArea.style.cssText =
      'width:100%;height:150px;background:black;color:#0f0;font-size:12px;padding:5px;border-radius:6px;';
    logHeader.onclick = () => {
      logArea.style.display = logArea.style.display === 'none' ? 'block' : 'none';
    };

    // Append everything neatly
    content.append(
      clockDisplay,
      countdownLabel,
      attemptCounterLabel,
      latencyLabel,
      visaSelect,
      retryDelayInput,
      tokenRefreshInput,
      timerHeader,
      timeContainer,
      addBtn,
      startBtn,
      stopBtn,
      sendNowBtn,
      skipBtn,
      logHeader,
      logArea
    );

    document.body.appendChild(panel);

    // ‚è∞ Live clock update
    setInterval(updateClock, 50);

    // üíæ Auto-save for every change
    [visaSelect, retryDelayInput, tokenRefreshInput].forEach((el) => {
      el.addEventListener('change', saveSettings);
      el.addEventListener('input', saveSettings);
    });
  }

  // üöÄ Initialize UI + Restore state
  function initializeScript() {
    retrieveToken();
    createUI();
    log('‚ú® Ready: Yalla-Visa v20.6 ‚Äî Fixed Timer + Latency Monitor + Persistent Settings');
  }

  window.addEventListener('load', initializeScript);

  // üß© Keep UI alive after SPA reload or token refresh
  const observer = new MutationObserver(() => {
    if (!document.getElementById('yallaVisaPanel')) {
      log('‚ôªÔ∏è UI missing, restoring...');
      initializeScript();
    }
  });
  observer.observe(document.documentElement, { childList: true, subtree: true });
})();
